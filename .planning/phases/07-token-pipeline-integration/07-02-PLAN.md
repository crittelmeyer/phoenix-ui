---
phase: 07-token-pipeline-integration
plan: 02
type: execute
wave: 2
depends_on: ['07-01']
files_modified:
  - packages/tokens/src/build.mjs
  - packages/tokens/package.json
autonomous: true

must_haves:
  truths:
    - 'pnpm build in packages/tokens outputs both CSS and Figma JSON'
    - 'dist/figma/light.json contains hex color values not OKLCH'
    - 'dist/figma/dark.json contains hex color values not OKLCH'
    - 'dist/figma/token-mapping.json documents Phoenix to Figma paths'
    - 'dist/color-comparison.html shows OKLCH vs hex preview'
    - 'Token names use slash hierarchy (color/semantic/primary)'
    - 'Build fails atomically if any output fails'
  artifacts:
    - path: 'packages/tokens/src/build.mjs'
      provides: 'Extended build script with Figma output'
      contains: 'registerTransforms'
    - path: 'packages/tokens/dist/figma/light.json'
      provides: 'Light mode Figma tokens'
      contains: 'phoenix-light'
    - path: 'packages/tokens/dist/figma/dark.json'
      provides: 'Dark mode Figma tokens'
      contains: 'phoenix-dark'
    - path: 'packages/tokens/dist/figma/token-mapping.json'
      provides: 'Token name mapping documentation'
      contains: 'figmaPath'
    - path: 'packages/tokens/dist/color-comparison.html'
      provides: 'Visual color fidelity report'
      contains: 'OKLCH to RGB'
  key_links:
    - from: 'build.mjs'
      to: '@tokens-studio/sd-transforms'
      via: 'registerTransforms import and call'
      pattern: 'await registerTransforms'
    - from: 'build.mjs'
      to: 'src/formats/*.mjs'
      via: 'StyleDictionary.registerFormat'
      pattern: 'registerFormat'
    - from: 'dist/figma/light.json'
      to: 'color values'
      via: 'ts/color/modifiers transform'
      pattern: '#[0-9a-fA-F]{6}'
---

<objective>
Extend the Style Dictionary build script to output Figma-compatible tokens alongside existing CSS.

Purpose: Completes the token pipeline integration by wiring sd-transforms and custom formats into the build process. After this plan, `pnpm build` outputs both OKLCH CSS for the web app and hex JSON for Figma import.

Output: Extended build.mjs, Figma token outputs in dist/figma/, color comparison HTML, package.json exports updated.
</objective>

<execution_context>
@/Users/chris/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-token-pipeline-integration/07-RESEARCH.md
@.planning/phases/07-token-pipeline-integration/07-CONTEXT.md
@.planning/phases/07-token-pipeline-integration/07-01-SUMMARY.md
@packages/tokens/src/build.mjs
@packages/tokens/src/formats/tokens-studio.mjs
@packages/tokens/src/formats/token-mapping.mjs
@packages/tokens/src/formats/color-comparison.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend build.mjs with sd-transforms and Figma outputs</name>
  <files>packages/tokens/src/build.mjs</files>
  <action>
Rewrite build.mjs to:
1. Import and register sd-transforms globally
2. Register custom formats from src/formats/
3. Keep existing CSS output unchanged
4. Add Figma platform outputs (light.json, dark.json, token-mapping.json)
5. Add color comparison HTML output
6. Fail atomically if any build fails

Critical patterns from research:

**Register sd-transforms before creating StyleDictionary instances:**

```javascript
import { registerTransforms } from '@tokens-studio/sd-transforms'
import StyleDictionary from 'style-dictionary'

await registerTransforms(StyleDictionary, {
  expand: {
    typography: false, // Phoenix doesn't use composite typography
    border: false,
    shadow: false,
  },
  excludeParentKeys: true,
  'ts/color/modifiers': {
    format: 'hex', // Output hex for Figma compatibility
  },
})
```

**Register custom formats:**

```javascript
import { colorComparisonFormat } from './formats/color-comparison.mjs'
import { tokenMappingFormat } from './formats/token-mapping.mjs'
import { tokensStudioFormat } from './formats/tokens-studio.mjs'

StyleDictionary.registerFormat({
  name: 'phoenix/tokens-studio',
  format: tokensStudioFormat,
})
// ... register others
```

**Figma platform configuration:**

```javascript
{
  figma: {
    transformGroup: 'tokens-studio', // Registered by sd-transforms
    buildPath: 'dist/figma/',
    files: [
      {
        destination: 'light.json',
        format: 'phoenix/tokens-studio',
        options: {
          tokenSetName: 'phoenix-light',
        },
      },
    ],
  },
}
```

**Key requirements:**

- CSS output must still use transformGroup: 'css' (preserves OKLCH)
- Figma output must use transformGroup: 'tokens-studio' (converts to hex)
- outputReferences: false for Figma (resolve all references to final values)
- Token set names: 'phoenix-light' and 'phoenix-dark' (separate sets, not overwriting)
- Atomic failure: wrap all builds in try/catch, exit(1) on any failure
- Log all generated files at end

Complete rewrite of build.mjs with both CSS and Figma outputs.
</action>
<verify>
File packages/tokens/src/build.mjs:

- Contains `import { registerTransforms }` from sd-transforms
- Contains `await registerTransforms(StyleDictionary`
- Contains `StyleDictionary.registerFormat` calls for custom formats
- Contains both 'css' and 'figma' platform configurations
- Contains try/catch with process.exit(1) for atomic failure
  </verify>
  <done>build.mjs extended with sd-transforms integration and Figma output configuration.</done>
  </task>

<task type="auto">
  <name>Task 2: Run build and verify outputs</name>
  <files>
    packages/tokens/dist/figma/light.json
    packages/tokens/dist/figma/dark.json
    packages/tokens/dist/figma/token-mapping.json
    packages/tokens/dist/color-comparison.html
  </files>
  <action>
Run the token build and verify all outputs are generated correctly.

```bash
cd packages/tokens && pnpm build
```

After successful build, verify:

1. **Figma JSON files exist and are valid:**
   - dist/figma/light.json - wrapped in "phoenix-light" token set
   - dist/figma/dark.json - wrapped in "phoenix-dark" token set

2. **Colors are hex, not OKLCH:**

   ```bash
   grep -c "#[0-9a-fA-F]\{6\}" dist/figma/light.json
   ```

   Should return count > 0 (hex colors found)

   ```bash
   grep -c "oklch" dist/figma/light.json
   ```

   Should return 0 (no OKLCH in Figma output)

3. **Token paths use slash hierarchy:**

   ```bash
   grep "color/semantic/primary" dist/figma/light.json
   ```

   Should find the path

4. **Token mapping documents correspondence:**
   - dist/figma/token-mapping.json exists
   - Contains phoenixName, figmaPath, type, value for each token

5. **Color comparison HTML is viewable:**
   - dist/color-comparison.html exists
   - Contains OKLCH source values and hex converted values

6. **CSS outputs unchanged:**
   - dist/tokens.css still contains OKLCH values
   - dist/tokens.dark.css still contains OKLCH values

If any output is missing or malformed, fix build.mjs and re-run.
</action>
<verify>

```bash
# All expected files exist
ls -la packages/tokens/dist/figma/
ls -la packages/tokens/dist/color-comparison.html

# Figma JSON has hex colors
grep -q "#[0-9a-fA-F]\{6\}" packages/tokens/dist/figma/light.json && echo "Has hex colors"

# CSS still has OKLCH
grep -q "oklch" packages/tokens/dist/tokens.css && echo "CSS preserved OKLCH"

# Token set names are correct
grep -q "phoenix-light" packages/tokens/dist/figma/light.json && echo "Light set named correctly"
grep -q "phoenix-dark" packages/tokens/dist/figma/dark.json && echo "Dark set named correctly"
```

  </verify>
  <done>Build succeeds, all 6 output files generated (2 CSS, 2 Figma JSON, 1 mapping, 1 HTML), colors converted correctly.</done>
</task>

<task type="auto">
  <name>Task 3: Update package.json exports for Figma tokens</name>
  <files>packages/tokens/package.json</files>
  <action>
Add exports for the new Figma token files so consuming packages can import them if needed.

Update the exports field in package.json:

```json
{
  "exports": {
    ".": "./src/index.ts",
    "./dist/tokens.css": "./dist/tokens.css",
    "./dist/tokens.dark.css": "./dist/tokens.dark.css",
    "./dist/figma/light.json": "./dist/figma/light.json",
    "./dist/figma/dark.json": "./dist/figma/dark.json",
    "./dist/figma/token-mapping.json": "./dist/figma/token-mapping.json"
  }
}
```

This enables future tooling to import Figma tokens programmatically:

```javascript
import lightTokens from '@phoenix/tokens/dist/figma/light.json'
```

  </action>
  <verify>
Run `cat packages/tokens/package.json | grep -A 10 '"exports"'` shows all 6 exports.
  </verify>
  <done>package.json exports include Figma token files for programmatic access.</done>
</task>

</tasks>

<verification>
After all tasks complete, run full verification:

1. **Build succeeds from clean state:**

   ```bash
   cd packages/tokens
   rm -rf dist/figma dist/color-comparison.html
   pnpm build
   ```

2. **All outputs exist:**

   ```bash
   ls -la dist/
   ls -la dist/figma/
   ```

   Expected: tokens.css, tokens.dark.css, figma/, color-comparison.html
   In figma/: light.json, dark.json, token-mapping.json

3. **Figma JSON is valid and importable:**

   ```bash
   node -e "const t = require('./dist/figma/light.json'); console.log(Object.keys(t))"
   ```

   Should output: ['phoenix-light']

4. **Color conversion worked:**
   - Open dist/color-comparison.html in browser
   - Verify OKLCH and hex previews are visually similar
   - Check for any unexpected black/white colors (gamut clipping issues)

5. **CSS output unchanged:**

   ```bash
   grep "oklch" dist/tokens.css | head -3
   ```

   Should show OKLCH values preserved

6. **Root build still works:**
   ```bash
   cd ../.. && pnpm build
   ```
   Should succeed with both CSS and Figma token outputs
   </verification>

<success_criteria>

- `pnpm build` in packages/tokens succeeds
- 6 output files generated: 2 CSS, 3 Figma JSON, 1 HTML
- Figma JSON contains hex colors (no OKLCH)
- CSS output still contains OKLCH colors (unchanged)
- Token paths use slash hierarchy in Figma output
- Token set names are 'phoenix-light' and 'phoenix-dark'
- Build fails atomically if any output fails
- package.json exports include Figma token paths
  </success_criteria>

<output>
After completion, create `.planning/phases/07-token-pipeline-integration/07-02-SUMMARY.md`
</output>
